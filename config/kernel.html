<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="utf-8">
        <title>内核 - Void Linux Handbook</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
        </script>
		<!-- Work around some values being stored in localStorage wrapped in quotes -->
		<script type="text/javascript">
			try {
				var sidebar = localStorage.getItem('mdbook-sidebar');

				if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
					localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
				}
			} catch (e) { }
		</script>

		<header>
			<nav id="void-nav">
				<ul>
					<li><a id="skip-to-content" tabindex="1" href="#main">Skip to content</a></li>
					<li>
						<button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
								<path d="M1 3v2h18V3zm0 8h18V9H1zm0 6h18v-2H1z"/>
							</svg>
						</button>
					</li>
					<li>
						<button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
							<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
								<path d="M7.5 13c3.04 0 5.5-2.46 5.5-5.5S10.54 2 7.5 2 2 4.46 2 7.5 4.46 13 7.5 13zm4.55.46C10.79 14.43 9.21 15 7.5 15 3.36 15 0 11.64 0 7.5S3.36 0 7.5 0C11.64 0 15 3.36 15 7.5c0 1.71-.57 3.29-1.54 4.55l6.49 6.49-1.41 1.41-6.49-6.49z"/>
							</svg>
						</button>
					</li>
                                        <noscript>
                                          <li class="js-unavailable">Search functionality requires JavaScript</li>
                                        </noscript>
				</ul>
				<ul id="nav-right">
					<li><a href="https://www.voidlinux.org">Home</a></li>
					<li><a href="https://www.voidlinux.org/news/">News</a></li>
					<li><a href="https://www.voidlinux.org/download/">Download</a></li>
					<li><a href="https://www.voidlinux.org/packages/">Packages</a></li>
					<li><a href="https://docs.voidlinux.org">Documentation</a></li>
					<li><a href="https://man.voidlinux.org/">Manual Pages</a></li>
					<li><a href="https://github.com/void-linux">GitHub</a></li>
				</ul>
			</nav>
		</header>

		<div id="content">

			<!-- Hide / unhide sidebar before it is displayed -->
			<script type="text/javascript">
				var html = document.querySelector('html');
				var sidebar = 'hidden';
				if (document.body.clientWidth >= 1080) {
					try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
					sidebar = sidebar || 'visible';
				}
				html.classList.remove('sidebar-visible');
				html.classList.add("sidebar-" + sidebar);
			</script>

			<nav id="sidebar" aria-label="Table of contents">
				<ol class="chapter"><li class="chapter-item expanded "><a href="../about/index.html"><strong aria-hidden="true">1.</strong> 关于</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../about/history.html"><strong aria-hidden="true">1.1.</strong> 历史</a></li><li class="chapter-item expanded "><a href="../about/about-this-handbook.html"><strong aria-hidden="true">1.2.</strong> 关于本手册</a></li><li class="chapter-item expanded "><a href="../about/infradocs.html"><strong aria-hidden="true">1.3.</strong> InfraDocs</a></li></ol></li><li class="chapter-item expanded "><a href="../installation/index.html"><strong aria-hidden="true">2.</strong> 安装</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../installation/live-images/index.html"><strong aria-hidden="true">2.1.</strong> Live 安装程序</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../installation/live-images/prep.html"><strong aria-hidden="true">2.1.1.</strong> 准备安装介质</a></li><li class="chapter-item expanded "><a href="../installation/live-images/partitions.html"><strong aria-hidden="true">2.1.2.</strong> 分区说明</a></li><li class="chapter-item expanded "><a href="../installation/live-images/guide.html"><strong aria-hidden="true">2.1.3.</strong> 安装指南</a></li></ol></li><li class="chapter-item expanded "><a href="../installation/guides/index.html"><strong aria-hidden="true">2.2.</strong> 进阶安装指南</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../installation/guides/chroot.html"><strong aria-hidden="true">2.2.1.</strong> 通过 chroot 安装 (x86/x86_64/aarch64)</a></li><li class="chapter-item expanded "><a href="../installation/guides/fde.html"><strong aria-hidden="true">2.2.2.</strong> 全盘加密</a></li><li class="chapter-item expanded "><a href="../installation/guides/zfs.html"><strong aria-hidden="true">2.2.3.</strong> 全盘 ZFS</a></li><li class="chapter-item expanded "><a href="../installation/guides/arm-devices/index.html"><strong aria-hidden="true">2.2.4.</strong> ARM 设备</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../installation/guides/arm-devices/platforms.html"><strong aria-hidden="true">2.2.4.1.</strong> 所支持的平台</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../installation/musl.html"><strong aria-hidden="true">2.3.</strong> musl</a></li></ol></li><li class="chapter-item expanded "><a href="../config/index.html"><strong aria-hidden="true">3.</strong> 配置</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../config/package-documentation/index.html"><strong aria-hidden="true">3.1.</strong> 软件文档</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../config/package-documentation/man.html"><strong aria-hidden="true">3.1.1.</strong> 手册页</a></li></ol></li><li class="chapter-item expanded "><a href="../config/firmware.html"><strong aria-hidden="true">3.2.</strong> 驱动</a></li><li class="chapter-item expanded "><a href="../config/locales.html"><strong aria-hidden="true">3.3.</strong> 本地化与翻译</a></li><li class="chapter-item expanded "><a href="../config/users-and-groups.html"><strong aria-hidden="true">3.4.</strong> 用户和用户组</a></li><li class="chapter-item expanded "><a href="../config/services/index.html"><strong aria-hidden="true">3.5.</strong> 服务与守护进程 - runit</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../config/services/user-services.html"><strong aria-hidden="true">3.5.1.</strong> 每个用户的服务</a></li><li class="chapter-item expanded "><a href="../config/services/logging.html"><strong aria-hidden="true">3.5.2.</strong> 日志</a></li></ol></li><li class="chapter-item expanded "><a href="../config/rc-files.html"><strong aria-hidden="true">3.6.</strong> rc.conf, rc.local 还有 rc.shutdown</a></li><li class="chapter-item expanded "><a href="../config/cron.html"><strong aria-hidden="true">3.7.</strong> Cron</a></li><li class="chapter-item expanded "><a href="../config/ssd.html"><strong aria-hidden="true">3.8.</strong> 固态硬盘</a></li><li class="chapter-item expanded "><a href="../config/security/index.html"><strong aria-hidden="true">3.9.</strong> 安全</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../config/security/apparmor.html"><strong aria-hidden="true">3.9.1.</strong> AppArmor</a></li></ol></li><li class="chapter-item expanded "><a href="../config/date-time.html"><strong aria-hidden="true">3.10.</strong> 日期和时间</a></li><li class="chapter-item expanded "><a href="../config/kernel.html" class="active"><strong aria-hidden="true">3.11.</strong> 内核</a></li><li class="chapter-item expanded "><a href="../config/power-management.html"><strong aria-hidden="true">3.12.</strong> 电源管理</a></li><li class="chapter-item expanded "><a href="../config/network/index.html"><strong aria-hidden="true">3.13.</strong> 网络</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../config/network/firewalls.html"><strong aria-hidden="true">3.13.1.</strong> 防火墙</a></li><li class="chapter-item expanded "><a href="../config/network/wpa_supplicant.html"><strong aria-hidden="true">3.13.2.</strong> wpa_supplicant</a></li><li class="chapter-item expanded "><a href="../config/network/iwd.html"><strong aria-hidden="true">3.13.3.</strong> IWD</a></li><li class="chapter-item expanded "><a href="../config/network/networkmanager.html"><strong aria-hidden="true">3.13.4.</strong> NetworkManager</a></li><li class="chapter-item expanded "><a href="../config/network/connman.html"><strong aria-hidden="true">3.13.5.</strong> ConnMan</a></li></ol></li><li class="chapter-item expanded "><a href="../config/network-filesystems.html"><strong aria-hidden="true">3.14.</strong> 网络文件系统</a></li><li class="chapter-item expanded "><a href="../config/session-management.html"><strong aria-hidden="true">3.15.</strong> Session 和 Seat 管理</a></li><li class="chapter-item expanded "><a href="../config/graphical-session/index.html"><strong aria-hidden="true">3.16.</strong> 图形 Session</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../config/graphical-session/graphics-drivers/index.html"><strong aria-hidden="true">3.16.1.</strong> 图形设备</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../config/graphical-session/graphics-drivers/amd.html"><strong aria-hidden="true">3.16.1.1.</strong> AMD or ATI</a></li><li class="chapter-item expanded "><a href="../config/graphical-session/graphics-drivers/intel.html"><strong aria-hidden="true">3.16.1.2.</strong> Intel</a></li><li class="chapter-item expanded "><a href="../config/graphical-session/graphics-drivers/nvidia.html"><strong aria-hidden="true">3.16.1.3.</strong> NVIDIA</a></li><li class="chapter-item expanded "><a href="../config/graphical-session/graphics-drivers/optimus.html"><strong aria-hidden="true">3.16.1.4.</strong> NVIDIA Optimus</a></li></ol></li><li class="chapter-item expanded "><a href="../config/graphical-session/xorg.html"><strong aria-hidden="true">3.16.2.</strong> Xorg</a></li><li class="chapter-item expanded "><a href="../config/graphical-session/wayland.html"><strong aria-hidden="true">3.16.3.</strong> Wayland</a></li><li class="chapter-item expanded "><a href="../config/graphical-session/fonts.html"><strong aria-hidden="true">3.16.4.</strong> 字体</a></li><li class="chapter-item expanded "><a href="../config/graphical-session/icons.html"><strong aria-hidden="true">3.16.5.</strong> 图标</a></li><li class="chapter-item expanded "><a href="../config/graphical-session/gnome.html"><strong aria-hidden="true">3.16.6.</strong> GNOME</a></li><li class="chapter-item expanded "><a href="../config/graphical-session/kde.html"><strong aria-hidden="true">3.16.7.</strong> KDE</a></li></ol></li><li class="chapter-item expanded "><a href="../config/media/index.html"><strong aria-hidden="true">3.17.</strong> 多媒体</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../config/media/alsa.html"><strong aria-hidden="true">3.17.1.</strong> ALSA</a></li><li class="chapter-item expanded "><a href="../config/media/pipewire.html"><strong aria-hidden="true">3.17.2.</strong> PipeWire</a></li><li class="chapter-item expanded "><a href="../config/media/pulseaudio.html"><strong aria-hidden="true">3.17.3.</strong> PulseAudio</a></li><li class="chapter-item expanded "><a href="../config/media/sndio.html"><strong aria-hidden="true">3.17.4.</strong> sndio</a></li></ol></li><li class="chapter-item expanded "><a href="../config/bluetooth.html"><strong aria-hidden="true">3.18.</strong> 蓝牙</a></li><li class="chapter-item expanded "><a href="../config/texlive.html"><strong aria-hidden="true">3.19.</strong> TeX Live</a></li><li class="chapter-item expanded "><a href="../config/external-applications.html"><strong aria-hidden="true">3.20.</strong> 更多程序</a></li><li class="chapter-item expanded "><a href="../config/print/index.html"><strong aria-hidden="true">3.21.</strong> 打印</a></li><li class="chapter-item expanded "><a href="../config/containers-and-vms/index.html"><strong aria-hidden="true">3.22.</strong> 容器与虚拟化</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../config/containers-and-vms/chroot.html"><strong aria-hidden="true">3.22.1.</strong> Chroots and Containers</a></li><li class="chapter-item expanded "><a href="../config/containers-and-vms/libvirt.html"><strong aria-hidden="true">3.22.2.</strong> libvirt</a></li><li class="chapter-item expanded "><a href="../config/containers-and-vms/lxc.html"><strong aria-hidden="true">3.22.3.</strong> LXC</a></li></ol></li><li class="chapter-item expanded "><a href="../config/openpgp.html"><strong aria-hidden="true">3.23.</strong> OpenPGP</a></li></ol></li><li class="chapter-item expanded "><a href="../xbps/index.html"><strong aria-hidden="true">4.</strong> XBPS 软件管理器</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../xbps/advanced-usage.html"><strong aria-hidden="true">4.1.</strong> 高级用法</a></li><li class="chapter-item expanded "><a href="../xbps/repositories/index.html"><strong aria-hidden="true">4.2.</strong> 软件源</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../xbps/repositories/mirrors/index.html"><strong aria-hidden="true">4.2.1.</strong> 镜像</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../xbps/repositories/mirrors/changing.html"><strong aria-hidden="true">4.2.1.1.</strong> 更换镜像</a></li><li class="chapter-item expanded "><a href="../xbps/repositories/mirrors/tor.html"><strong aria-hidden="true">4.2.1.2.</strong> 使用 Tor 镜像</a></li></ol></li><li class="chapter-item expanded "><a href="../xbps/repositories/restricted.html"><strong aria-hidden="true">4.2.2.</strong> 受限制的软件</a></li><li class="chapter-item expanded "><a href="../xbps/repositories/custom.html"><strong aria-hidden="true">4.2.3.</strong> 自定义的软件源</a></li><li class="chapter-item expanded "><a href="../xbps/repositories/signing.html"><strong aria-hidden="true">4.2.4.</strong> 签名软件源</a></li></ol></li><li class="chapter-item expanded "><a href="../xbps/troubleshooting/index.html"><strong aria-hidden="true">4.3.</strong> XBPS 的故障排除</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../xbps/troubleshooting/common-issues.html"><strong aria-hidden="true">4.3.1.</strong> 常见问题</a></li><li class="chapter-item expanded "><a href="../xbps/troubleshooting/static.html"><strong aria-hidden="true">4.3.2.</strong> Static XBPS</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../contributing/index.html"><strong aria-hidden="true">5.</strong> 贡献</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../contributing/void-docs/index.html"><strong aria-hidden="true">5.1.</strong> 贡献于 void-docs</a></li></ol></li></ol>
			</nav>

			<!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
			<script type="text/javascript">
				document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
	document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
	Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
		link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
	});
			</script>

			<div id="page-wrapper">
				<div id="search-wrapper" class="hidden">
					<form id="searchbar-outer" class="searchbar-outer">
						<input type="search" name="search" id="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
					</form>
					<div id="searchresults-outer" class="searchresults-outer hidden">
						<div id="searchresults-header" class="searchresults-header"></div>
						<ul id="searchresults">
						</ul>
					</div>
				</div>

				<main id="main">
					<h1 id="内核"><a class="header" href="#内核">内核</a></h1>
<h2 id="内核系列"><a class="header" href="#内核系列">内核系列</a></h2>
<p>Void Linux 在默认版本库中提供了许多内核系列。这些被命名为 <code>linux&lt;x&gt;.&lt;y&gt;</code>：例如，<code>linux4.19</code>。你可以通过运行以下命令查询所有可用的内核系列：</p>
<pre><code>$ xbps-query --regex -Rs '^linux[0-9.]+-[0-9._]+'
</code></pre>
<p>默认安装的 <code>linux</code> 元包依赖于其中一个内核包，通常是包含最新的主线内核的包，可以与所有 DKMS 模块一起工作。较新的内核可能在资源库中可用，但不一定被认为稳定到可以作为默认的内核；使用这些内核的风险由你自己承担。如果你希望使用一个较新的内核，并且有需要构建的 DKMS 模块，请安装相关的 <code>linux&lt;x&gt;.&lt;y&gt;-headers</code> 软件包，然后使用 <a href="https://man.voidlinux.org/xbps-reconfigure.1">xbps-reconfigure(1)</a> 重新配置你安装的 <code>linux&lt;x&gt;.&lt;y&gt;</code> 软件包。这将构建 DKMS 模块。</p>
<h2 id="删除旧内核"><a class="header" href="#删除旧内核">删除旧内核</a></h2>
<p>当更新内核时，旧的版本会被留下，以防有必要回滚到旧的版本。随着时间的推移，旧的内核版本会积累起来，消耗磁盘空间，增加 DKMS 模块更新的时间。此外，如果 <code>/boot</code> 是一个独立的分区，并且被旧的内核填满，更新可能会失败，或者导致生成不完整的 initramfs 文件系统，如果它们被启动，会导致内核恐慌(kernel panics)。因此，建议定时地清理旧内核。</p>
<p><code>vkpurge</code> 预先安装在每个 Void Linux 系统上，删除旧内核是通过 <a href="https://man.voidlinux.org/vkpurge.8">vkpurge(8)</a> 工具完成的。这个工具在移除旧内核时运行必要的 hooks。注意，<code>vkpurge</code> 不会删除内核 <em>软件包</em>，只删除特定的 <em>内核</em>。</p>
<h2 id="移除默认的内核系列"><a class="header" href="#移除默认的内核系列">移除默认的内核系列</a></h2>
<p>如果你已经安装了默认之外的系列内核包，并且想移除默认的内核包，你应该安装 <code>linux-base</code> 包，或者在已经安装的情况下将其<a href="https://man.voidlinux.org/xbps-pkgdb.1">标记为手动软件包</a>。在这个过程之后，你可以用 <a href="https://man.voidlinux.org/xbps-remove.1">xbps-remove(1)</a> 删除默认的内核包。可能有必要在 <a href="https://man.voidlinux.org/xbps.d.5">xbps.d(5)</a> 中的 <code>ignorepkg</code> 条目中加入 <code>linux</code> 和 <code>linux-headers</code>，因为基础包可能依赖于它们。</p>
<h2 id="换成其他内核系列"><a class="header" href="#换成其他内核系列">换成其他内核系列</a></h2>
<p>如果你想使用 <code>linux-lts</code> 或 <code>linux-mainline</code> 内核系列而不是默认的 <code>linux</code>，首先安装所需的系列元包（及 <code>linux-lts-headers</code> 或<code>linux-mainline-headers</code> 元包）。然后，你可以将 <code>linux</code> 和 <code>linux-headers</code> 添加到 <a href="https://man.voidlinux.org/xbps.d.5">xbps.d(5)</a> 中的 <code>ignorepkg</code> 条目中，并卸载这些包。</p>
<h2 id="改变默认的-initramfs-生成器"><a class="header" href="#改变默认的-initramfs-生成器">改变默认的 initramfs 生成器</a></h2>
<p>默认情况下，Void Linux 使用 <a href="https://man.voidlinux.org/dracut.8">dracut</a> 为安装的内核准备 initramfs 镜像。替代品如 <a href="https://man.voidlinux.org/mkinitcpio.8">mkinitcpio</a> 是可用的。每个 initramfs 生成器都在 initramfs 组中注册了一个 <a href="https://man.voidlinux.org/xbps-alternatives.1">XBPS alternative</a> ，以链接其<a href="#%E5%86%85%E6%A0%B8-hooks">内核 hooks</a>，在为特定内核创建或移除 initramfs 镜像时使用。</p>
<p>要用 mkinitcpio <em>等等</em> 替换 dracut，请安装 <code>mkinitcpio</code> 软件包；确认 <code>mkinitcpio</code> 出现在可用的替代品列表中，方法是运行:</p>
<pre><code>$ xbps-alternatives -l -g initramfs
</code></pre>
<p>执行指令</p>
<pre><code># xbps-alternatives -s mkinitcpio
</code></pre>
<p>用 mkinitcpio 提供的钩子替换 dracut 的内核 hooks。在随后的内核更新中（或对 DKMS 包的更新触发了 initramfs 的再生），mkinitcpio 将被用来代替 dracut 来准备 initramfs 镜像。要强迫镜像重新生成，请重新配置你的内核包，运行：</p>
<pre><code># xbps-reconfigure -f linux&lt;x&gt;.&lt;y&gt;
</code></pre>
<p>对于当前安装的每个 <code>linux&lt;x&gt;.&lt;y&gt;</code> 软件包。</p>
<h2 id="cmdline"><a class="header" href="#cmdline">cmdline</a></h2>
<p>内核、初始 RAM 磁盘（initrd）和一些系统程序可以在启动时通过内核命令行参数进行配置。内核理解的参数在 <a href="https://www.kernel.org/doc/html/latest/admin-guide/kernel-parameters.html">kernel-parameters</a>文档和<a href="https://man.voidlinux.org/bootparam.7">bootparam(7)</a> 中解释。dracut 理解的参数可以在<a href="https://man.voidlinux.org/dracut.cmdline.7">dracut.cmdline(7)</a> 中找到。</p>
<p>一旦系统被启动，当前的内核命令行参数可以在 <code>/proc/cmdline</code> 文件中找到。一些系统程序可以根据命令行中传递的参数来改变它们的行为，例如，在<a href="./services/index.html#booting-a-different-runsvdir">启动不同的 runtvdir</a> 时就会发生这种情况。</p>
<p>有不同的方法来设置这些参数，下面将解释其中一些方法。</p>
<h3 id="grub"><a class="header" href="#grub">GRUB</a></h3>
<p>内核命令行参数可以通过编辑 <code>/etc/default/grub</code>，改变 <code>GRUB_CMDLINE_LINUX_DEFAULT</code> 变量，然后运行<code>update-grub</code>，通过 GRUB 引导程序添加。</p>
<h3 id="dracut"><a class="header" href="#dracut">dracut</a></h3>
<p>Dracut 提供了一个 <a href="https://man.voidlinux.org/dracut.conf.5"><code>kernel_cmdline</code> 配置选项</a> 和<a href="https://man.voidlinux.org/dracut.8"><code>--kernel-cmdline</code>命令行选项</a>，将直接在 initramfs 镜像中编码命令行参数。当 dracut 被用来创建一个 UEFI 可执行文件时，用这些选项设置的参数将被传递给内核。然而，当产生一个普通的 initramfs 时，这些选项在启动时不会被传递给内核。相反，它们将被写入镜像中的 <code>/etc/cmdline.d</code> 中的一个配置文件。虽然 dracut 解析这个配置来控制它自己的启动时行为，但内核本身不会知道通过这个机制设置的任何东西。</p>
<p>在修改 dracut 配置后，重新生成 initramfs，以确保它包括这些变化。</p>
<h2 id="内核加固"><a class="header" href="#内核加固">内核加固</a></h2>
<p>Void Linux在默认时启用了一些内核安全选项。这最初是由内核命令行参数 <code>slub_debug=P page_poison=1</code> 提供的，但从内核 5.3 系列开始，这些参数被 <code>init_on_alloc</code> 和 <code>init_on_free</code> 取代（见<a href="https://github.com/torvalds/linux/commit/6471384af">此提交</a>）。</p>
<p>Void 的内核在可用的情况下默认启用 <code>init_on_alloc</code> 选项（即 <code>linux5.4</code> 及以上版本）。在大多数情况下，你通常不应该禁用它，因为它对性能的影响相当小（1% 以内）。<code>init_on_free</code> 选项更加昂贵（平均 5% 左右），需要通过在内核命令行传递 <code>init_on_free=1</code> 来手动启用。如果你需要禁用 <code>init_on_alloc</code>，你可以通过传递 <code>init_on_alloc=0</code> 来实现。</p>
<p>有可能你现有的系统仍然启用了旧的选项。它们在较新的内核中仍然有效，但对性能的影响与 <code>init_on_free=1</code> 更为接近。在较老的硬件上，这可能是相当明显的。如果你运行的内核系列早于 5.4，你可以保留它们（或者增加它们），以牺牲速度为代价获得额外的安全性；否则你应该删除它们。</p>
<h2 id="内核模块"><a class="header" href="#内核模块">内核模块</a></h2>
<p>内核模块通常是文件系统或设备驱动程序。</p>
<h3 id="在启动过程中加载内核模块"><a class="header" href="#在启动过程中加载内核模块">在启动过程中加载内核模块</a></h3>
<p>通常情况下，内核会自动加载所需的模块，但有时可能需要明确指定启动时要加载的模块。</p>
<p>为了在启动过程中加载内核模块，需要创建一个像 <code>/etc/modules-load.d/virtio.conf</code> 这样的 <code>.conf</code> 文件，其内容是：</p>
<pre><code># load virtio-net
virtio-net
</code></pre>
<h3 id="把内核模块禁用"><a class="header" href="#把内核模块禁用">把内核模块禁用</a></h3>
<p>将内核模块禁用是一种防止模块被内核加载的方法。有两种不同的方法将内核模块禁用，一种是由 initramfs 加载的模块，另一种是 initramfs 进程结束后加载的模块。由 initramfs 加载的模块必须在 initramfs 配置中禁用。</p>
<p>要将 initramfs 过程后加载的模块列入黑名单，创建一个 <code>.conf</code> 文件，如 <code>/etc/modprobe.d/radeon.conf</code>，其内容为：</p>
<pre><code>blacklist radeon
</code></pre>
<h4 id="在-initramfs-中禁用模块"><a class="header" href="#在-initramfs-中禁用模块">在 initramfs 中禁用模块</a></h4>
<p>在对配置文件进行必要的修改后，需要重新生成 initramfs，以便在下一次启动时使修改生效。</p>
<h5 id="dracut-1"><a class="header" href="#dracut-1">dracut</a></h5>
<p>Dracut 可以通过一个配置文件配置为不包括内核模块。要把模块列入 dracut initramfs 的黑名单，可以创建一个<code>.conf</code> 文件，如 <code>/etc/dracut.conf.d/radeon.conf</code>，其内容如下：</p>
<pre><code>omit_drivers+=&quot; radeon &quot;
</code></pre>
<h5 id="mkinitcpio"><a class="header" href="#mkinitcpio">mkinitcpio</a></h5>
<p>To blacklist modules from being included in a mkinitcpio initramfs a <code>.conf</code>
file needs to be created like <code>/etc/modprobe.d/radeon.conf</code> with the contents:</p>
<p>为了将模块禁用，需要创建一个 <code>.conf</code> 文件，如 <code>/etc/modprobe.d/radeon.conf</code>，以防止模块被包含在 mkinitcpio initramfs 中。</p>
<pre><code>blacklist radeon
</code></pre>
<h2 id="内核-hooks"><a class="header" href="#内核-hooks">内核 hooks</a></h2>
<p>Void Linux 在 <code>/etc/kernel.d/{pre-install,post-install,pre-remove,post-remove}</code> 中为内核 hooks 提供了目录。</p>
<p>这些 hooks 被用来更新像 <code>grub</code>、<code>gummiboot</code> 和 <code>lilo</code> 等引导程序的引导菜单。</p>
<h3 id="安装-hooks"><a class="header" href="#安装-hooks">安装 hooks</a></h3>
<p><code>{pre,post}-install</code> hooks 是由 <a href="https://man.voidlinux.org/xbps-reconfigure.1">xbps-reconfigure(1)</a> 在配置 Linux 内核时执行的，比如构建其 initramfs。这发生在第一次安装或更新内核系列时，但也可以手动运行：</p>
<pre><code># xbps-reconfigure --force linux&lt;x&gt;.&lt;y&gt;
</code></pre>
<p>如果手动运行，它们的作用是将 initramfs 的配置变化应用于下一次启动。</p>
<h3 id="删除-hooks"><a class="header" href="#删除-hooks">删除 hooks</a></h3>
<p><a href="https://man.voidlinux.org/vkpurge.8">vkpurge(8)</a> 在删除旧内核时执行 <code>{pre,post}-remove</code> hooks。</p>
<h2 id="动态内核模块支持-dkms"><a class="header" href="#动态内核模块支持-dkms">动态内核模块支持 (DKMS)</a></h2>
<p>有一些不属于 Linux 源码树的内核模块，在安装时使用 DKMS 和内核 hooks 构建。可用的模块可以通过在软件包库中搜索<code>dkms</code> 来列出。</p>
<p>DKMS 构建日志在 <code>/var/lib/dkms/</code>.</p>

				</main>

				<nav id="nav-wide-wrapper" aria-label="Page navigation">
						<a href="../config/date-time.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
							<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20">
								<path d="M4 10l9 9 1.4-1.5L7 10l7.4-7.5L13 1z"/>
							</svg>
						</a>

						<a href="../config/power-management.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
							<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 20 20">
								<path d="M7 1L5.6 2.5 13 10l-7.4 7.5L7 19l9-9z"/>
							</svg>
						</a>
				</nav>
			</div>
		</div>


        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>

        <script src="../book.js" type="text/javascript" charset="utf-8"></script>
    </body>
</html>
